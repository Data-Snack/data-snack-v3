import { NextRequest, NextResponse } from 'next/server';\nimport { GDPRTracker } from '@data-snack/tracking';\nimport { z } from 'zod';\n\nconst GDPRRequestSchema = z.object({\n  action: z.enum(['export', 'delete']),\n  userId: z.string().uuid(),\n  email: z.string().email().optional(),\n  reason: z.string().optional(),\n});\n\nconst gdprTracker = new GDPRTracker({\n  enableDatabase: true,\n  debug: process.env.NODE_ENV === 'development',\n});\n\nconst corsHeaders = {\n  'Access-Control-Allow-Origin': process.env.NODE_ENV === 'development' \n    ? '*' \n    : 'https://data-snack.com',\n  'Access-Control-Allow-Methods': 'POST, OPTIONS',\n  'Access-Control-Allow-Headers': 'Content-Type',\n};\n\nexport async function OPTIONS() {\n  return new NextResponse(null, {\n    status: 204,\n    headers: corsHeaders,\n  });\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { action, userId, email, reason } = GDPRRequestSchema.parse(body);\n    \n    const clientIp = request.headers.get('x-forwarded-for')?.split(',')[0] || \n                    request.headers.get('x-real-ip') || \n                    'unknown';\n    \n    switch (action) {\n      case 'export': {\n        // Request data export\n        const exportData = await gdprTracker.requestDataExport(userId);\n        \n        // Log the export request\n        console.log(`[GDPR] Data export requested for user ${userId} from IP ${clientIp}`);\n        \n        return NextResponse.json(\n          {\n            success: true,\n            message: 'Data export completed',\n            data: exportData,\n            timestamp: new Date().toISOString(),\n          },\n          {\n            headers: {\n              ...corsHeaders,\n              'Content-Type': 'application/json',\n              'Content-Disposition': `attachment; filename=\"data-export-${userId}-${Date.now()}.json\"`,\n            },\n          }\n        );\n      }\n      \n      case 'delete': {\n        // Request data deletion\n        await gdprTracker.requestDataDeletion(userId);\n        \n        // Log the deletion request\n        console.log(`[GDPR] Data deletion requested for user ${userId} from IP ${clientIp}. Reason: ${reason || 'Not specified'}`);\n        \n        return NextResponse.json(\n          {\n            success: true,\n            message: 'Data deletion request submitted. Your data will be anonymized within 30 days.',\n            userId,\n            requestedAt: new Date().toISOString(),\n            deletionSchedule: 'Within 30 days',\n          },\n          {\n            headers: corsHeaders,\n          }\n        );\n      }\n      \n      default:\n        return NextResponse.json(\n          { error: 'Invalid action' },\n          { status: 400, headers: corsHeaders }\n        );\n    }\n    \n  } catch (error) {\n    console.error('[API] GDPR request error:', error);\n    \n    if (error instanceof z.ZodError) {\n      return NextResponse.json(\n        { \n          error: 'Invalid request format',\n          details: error.errors,\n        },\n        { \n          status: 400,\n          headers: corsHeaders,\n        }\n      );\n    }\n    \n    return NextResponse.json(\n      { \n        error: 'Failed to process GDPR request',\n        message: 'Please try again or contact support if the problem persists.',\n      },\n      { \n        status: 500,\n        headers: corsHeaders,\n      }\n    );\n  }\n}\n\n// Get GDPR information\nexport async function GET(request: NextRequest) {\n  const searchParams = request.nextUrl.searchParams;\n  const userId = searchParams.get('userId');\n  \n  if (!userId) {\n    return NextResponse.json(\n      { \n        gdprInfo: {\n          rights: [\n            'Right to be informed',\n            'Right of access',\n            'Right to rectification',\n            'Right to erasure (right to be forgotten)',\n            'Right to restrict processing',\n            'Right to data portability',\n            'Right to object',\n            'Rights related to automated decision making including profiling',\n          ],\n          dataRetention: '90 days for personal data, indefinite for anonymized data',\n          contactEmail: 'privacy@data-snack.com',\n          lastUpdated: '2024-12-01',\n        }\n      },\n      {\n        headers: corsHeaders,\n      }\n    );\n  }\n  \n  // For specific user, show their GDPR status\n  // In a real implementation, you'd check the database\n  return NextResponse.json(\n    {\n      userId,\n      gdprStatus: {\n        hasActiveData: true,\n        lastExport: null,\n        deletionRequested: false,\n        consentLastUpdated: new Date().toISOString(),\n      },\n      availableActions: ['export', 'delete'],\n    },\n    {\n      headers: corsHeaders,\n    }\n  );\n}\n